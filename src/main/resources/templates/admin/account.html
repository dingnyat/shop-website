<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout}">
<style>
  #add-account-modal .modal-body {
    overflow-y: auto;
    height: calc(100vh - 200px);
  }
</style>
<head>
  <title>Add Product</title>
  <!--js jquery ui autocomplete-->
  <script type="text/javascript" src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <!--js jquery table-->
  <script type="text/javascript" src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.js"></script>
  <!--bootstrap jquery table-->
  <script type="text/javascript" src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/select/1.3.0/js/dataTables.select.min.js"></script>
  <!--css jquery ui autocomplete-->
  <link rel="stylesheet" type="text/css" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"/>
  <!--bootstrap css jquery table-->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap4.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/select/1.3.0/css/select.bootstrap4.min.css">
  <script type="text/javascript" th:src="@{/ckeditor/ckeditor.js}"></script>
  <script type="text/javascript" th:src="@{/ckfinder/ckfinder.js}"></script>
  <script>
      let selectedImgUrl = "";
      let table;
      let selectedAccounts = new Set();

      $(function () {
          table = $("#account-table").DataTable({
              processing: true,
              serverSide: true,
              ajax: {
                  url: "/api/admin/account/table_data",
                  type: "POST",
                  dataType: "json",
                  contentType: "application/json",
                  data: function (datatableRequest) {
                      return JSON.stringify(datatableRequest);
                  }
              },
              deferRender: true,
              columns: [
                  {data: "id"},
                  {data: "id"},
                  {data: "name"},
                  {data: "address"},
                  {data: "phone"},
                  {data: "email"},
                  {data: "roles[, ].name"},
                  {data: "id"}
              ],
              columnDefs: [
                  {orderable: false, targets: [0, 6, 7]},
                  {
                      render: function () {
                          return "";
                      },
                      className: 'select-checkbox',
                      targets: 0
                  },

                  {
                      render: function (data, type, row) {
                          return '<button class="btn btn-sm btn-success ml-1"><i class="fas fa-info-circle"></i></button>'
                              + '<button onclick="editAccountBtnPerform(table.row($(this).parents(\'tr\')).data())" class="btn btn-sm btn-info ml-1"><i class="fas fa-edit"></i></button>'
                              + '<button data-toggle="modal" data-target="#delete-confirm-dialog" onclick="$(\'#delete-confirm-dialog\').attr(\'data-id\', table.row($(this).parents(\'tr\')).data().id)" class="btn btn-sm btn-danger ml-1"><i class="fas fa-trash-alt"></i></button>'
                              + '<button class="btn btn-sm btn-secondary ml-1"><i class="fas fa-cart-plus"></i></button>';
                      },
                      targets: 7
                  }
              ],
              select: {
                  style: 'multi',
                  selector: 'td:first-child'
              },
              order: [1, 'asc'],
              language: {
                  url: "https://cdn.datatables.net/plug-ins/1.10.19/i18n/Vietnameses.json"
              },
              lengthMenu: [10, 25, 50, 100, 200]
          });

          table.on("select", function (e, dt, type, indexes) {
              let rowData = table.rows(indexes).data();
              selectedAccounts.add(rowData[0].id);
          }).on("deselect", function (e, dt, type, indexes) {
              let rowData = table.rows(indexes).data();
              selectedAccounts.delete(rowData[0].id);
          });

          $('#account-form').submit(function (e) {
              e.preventDefault();
              let formdata = new FormData(this);

              if ($("#account-form button[type=submit]").html() === "Add") {
                  if (formdata.get("name").length <= 0 || formdata.get("password").length <= 0 || formdata.get("username").length <= 0 || formdata.get("phone").length <= 0 || formdata.get("address").length <= 0 || formdata.get("email").length <= 0) {
                      alert("Fields must be entered!");
                      return;
                  }
                  addAccount(formdata);
              } else {
                  let account = getAccountFromForm();
                  account.id = $("#account-form button[type=submit]").attr("data-edit-id");
                  editAccount(account);
              }
          });
          // pervent press enter to submit
          $('form').keydown(function (e) {
              if (e.keyCode === 13) {
                  e.preventDefault();
                  return false;
              }
          });
      });

      function getAccountFromForm() {
          let username = $("#input-username").val();
          let password = $("#input-password").val();
          let name = $("#input-name").val();
          let address = $("#input-address").val();
          let phone = $("#input-phone").val();
          let email = $("#input-email").val();
          let thumbnailUrl = selectedImgUrl;
          // simple (for testing) validation before post
          if (username.length <= 0 || password.length <= 0 || name.length <= 0
              || address.length <= 0 || phone.length <= 0 || email.length <= 0) {
              alert("Fields must be entered!");
              return;
          }
          return {
              "username": username,
              "password": password,
              "name": name,
              "address": address,
              "phone": phone,
              "email": email,
              "thumbnailUrl": thumbnailUrl
          };
      }

      function addAccountBtnPerform() {
          resetForm();
          $("#account-form-modal h3.modal-title").html("Add Account");
          $("#account-form-modal button[type=submit]").html("Add");
          $("#account-form-modal button[type=submit]").removeClass("btn-info");
          $("#account-form-modal button[type=submit]").addClass("btn-primary");
      }

      function editAccountBtnPerform(accountRow) {
          $("#account-form-modal h3.modal-title").html("Edit Account");
          $("#account-form-modal button[type=submit]").html("Edit");
          $("#account-form-modal button[type=submit]").removeClass("btn-primary");
          $("#account-form-modal button[type=submit]").addClass("btn-info");
          $("#account-form-modal button[type=submit]").attr("data-edit-id", accountRow.id);
          $("#input-name").val(accountRow.name);
          $("#input-address").val(accountRow.address);
          $("#input-phone").val(accountRow.phone);
          $("#input-email").val(accountRow.email);
          $("#input-file-label").html(accountRow.thumbnailUrl);
          selectedImgUrl = accountRow.thumbnailUrl;
          $("#account-form-modal").modal('show');
      }

      function resetForm() {
          selectedImgUrl = "";
          $("#input-username").val("");
          $("#input-password").val("");
          $("#input-name").val("");
          $("#input-address").val("");
          $("#input-phone").val("");
          $("#input-email").val("");
          $("#input-file-label").html("Choose thumbnail image...");
          $("#input-file-label").css("color", "black");
          $(".custom-combobox-input").val("");
      }

      function addAccount(formData) {
          $.ajax({
              url: "/admin/account/add",
              type: "POST",
              dataType: "text",
              contentType: false,
              processData: false,
              data: formData,
              success: function (receivedDataFromServer) {
                  resetForm();
                  $("#status-msg").html(receivedDataFromServer);
                  $("#account-form-modal").modal('hide');
                  $("#status-dialog").modal('show');
                  table.draw();
              },
              error: function () {
                  resetForm();
                  $("#status-msg").html("Can't connect to server!");
                  $("#account-form-modal").modal('hide');
                  $("#status-dialog").modal('show');
              }
          });
      }

      function editAccount(account) {
          $.ajax({
              url: "/api/admin/account/edit",
              type: "PUT",
              contentType: "application/json",
              data: JSON.stringify(account),
              success: function (receivedDataFromServer) {
                  resetForm();
                  $("#status-msg").html(receivedDataFromServer);
                  $("#account-form-modal").modal('hide');
                  $("#status-dialog").modal('show');
                  table.draw();
              },
              error: function () {
                  resetForm();
                  $("#status-msg").html("Can't connect to server!");
                  $("#account-form-modal").modal('hide');
                  $("#status-dialog").modal('show');
              }
          });
      }

      function deleteAccount(accountId) {
          if (accountId === undefined) return;
          $.ajax({
              url: "/api/admin/account/delete/" + accountId,
              type: "DELETE",
              dataType: "text",
              success: function (respData) {
                  $("#status-msg").html(respData);
                  $("#delete-confirm-dialog").modal("hide");
                  $("#delete-confirm-dialog").attr("data-id", null);
                  $("#status-dialog").modal("show");
                  table.draw();
              },
              error: function () {
                  $("#status-msg").html("Can't connect to server. Try later!");
                  $("#delete-confirm-dialog").modal("hide");
                  $("#delete-confirm-dialog").attr("data-id", null);
                  $("#status-dialog").modal("show");
              }
          });
      }

      function deleteSelectedAccounts() {
          if (selectedAccounts.size <= 0) {
              alert("Please select aleast an item!");
              return;
          }
          $.ajax({
              url: "/api/admin/account/selected-delete",
              type: "DELETE",
              contentType: "application/json",
              dataType: "text",
              data: JSON.stringify(Array.from(selectedAccounts)),
              success: function (respData) {
                  $("#status-msg").html(respData);
                  $("#status-dialog").modal("show");
                  table.draw();
                  selectedAccounts.clear();
              },
              error: function () {
                  $("#status-msg").html("Can't connect to server. Try later!");
                  $("#status-dialog").modal("show");
              }
          });
      }

      function changeSelectedFilename(e) {
          let fileName = e.value.split("\\").pop();
          $("#input-file-label").addClass("selected").html(fileName).css("color", "green");
      }
  </script>
  <style>
    #account-form-modal .modal-body {
      overflow-y: auto;
      height: calc(100vh - 200px);
    }

    .custom-form-div {
      margin: 0 15px 0 15px;
    }

    td {
      word-break: break-all;
    }
  </style>
</head>
<body>
<section layout:fragment="content_body">
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <div class="row my-4">
          <div class="col-md-6">
            <h3>List of Accounts</h3>
          </div>
          <div class="col-md-6">
            <button onclick="addAccountBtnPerform()" type="button" data-target="#account-form-modal" data-toggle="modal"
                    class="btn btn-primary">Add
            </button>
            <button type="button" data-target="#delete-all-confirm-dialog" data-toggle="modal" class="btn btn-danger">
              Delete
            </button>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12 table-responsive-md">
            <table id="account-table" class="table table-borderless table-hover">
              <thead>
              <tr>
                <th scope="col"></th>
                <th scope="col" style="width: 5%;">Id</th>
                <th scope="col" style="width: 20%;">Name</th>
                <th scope="col" style="width: 15%;">Address</th>
                <th scope="col" style="width: 10%;">Phone</th>
                <th scope="col" style="width: 20%;">Email</th>
                <th scope="col" style="width: 14%">Role</th>
                <th scope="col" style="width: 27%;">Action</th>
              </tr>
              </thead>
              <tfoot>
              <tr>
                <th></th>
                <th>Id</th>
                <th>Name</th>
                <th>Address</th>
                <th>Phone</th>
                <th>Email</th>
                <th>Role</th>
                <th>Action</th>
              </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!--account form modal-->
  <div class="modal fade" data-backdrop="static" data-keyboard="false" role="dialog" id="account-form-modal">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <form id="account-form" method="post" th:action="@{/admin/account/add}" enctype="multipart/form-data">
          <div class="modal-header">
            <h3 class="modal-title">Add account</h3>
            <button type="button" class="close" data-dismiss="modal">&times;</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label class="control-label col-md-2" for="input-username">Username:</label>
              <div class="col-md-12">
                <input class="form-control" name="username" id="input-username" type="text">
              </div>
            </div>
            <div class="form-group">
              <label class="control-label col-md-2" for="input-password">Password:</label>
              <div class="col-md-12">
                <input class="form-control" name="password" id="input-password" type="text">
              </div>
            </div>
            <div class="form-group">
              <label class="control-label col-md-2" for="input-name">Name:</label>
              <div class="col-md-12">
                <input class="form-control" name="name" id="input-name" type="text">
              </div>
            </div>
            <div class="form-group">
              <label class="control-label col-md-2" for="input-address">Address:</label>
              <div class="col-md-12">
                <input class="form-control" name="address" id="input-address" type="text">
              </div>
            </div>
            <div class="form-group">
              <label class="control-label col-md-2" for="input-phone">Phone:</label>
              <div class="col-md-12">
                <input class="form-control" name="phone" id="input-phone" type="text">
              </div>
            </div>
            <div class="form-group">
              <label class="control-label col-md-2" for="input-email">Email:</label>
              <div class="col-md-12">
                <input class="form-control" name="email" id="input-email" type="text">
              </div>
            </div>
            <div class="form-group">
              <label class="control-label col-md-2" for="input-file">Avatar:</label>
              <div class="custom-form-div">
                <div class="custom-file col-md-12">
                  <input type="file" name="multipartFile" id="input-file" class="custom-file-input"
                         onchange="changeSelectedFilename(this)">
                  <label class="custom-file-label" for="input-file" id="input-file-label">
                    Choose thumbnail image...
                  </label>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-warning" data-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Add</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!--status dialog-->
  <div class="modal" role="dialog" id="status-dialog">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content text-center">
        <div class="model-header">
          <h3 class="modal-title">Status</h3>
        </div>
        <div class="modal-body">
          <p id="status-msg"></p>
        </div>
        <div class="modal-footer mx-auto d-block">
          <button class="btn btn-warning" data-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  <!--confirm dialog-->
  <div class="modal" role="alertdialog" id="delete-confirm-dialog">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content text-center">
        <div class="model-header">
          <h3 class="modal-title">Confirmation</h3>
        </div>
        <div class="modal-body">
          <p>Do you want to execute this action?</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-warning" data-dismiss="modal">Cancel</button>
          <button class="btn btn-danger" onclick="deleteAccount($('#delete-confirm-dialog').attr('data-id'))">Delete
          </button>
        </div>
      </div>
    </div>
  </div>
  <!--delete all dialog-->
  <div class="modal" role="alertdialog" id="delete-all-confirm-dialog">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content text-center">
        <div class="model-header">
          <h3 class="modal-title">Confirmation</h3>
        </div>
        <div class="modal-body">
          <p>Do you want to delete the all selected item?</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-warning" data-dismiss="modal">Cancel</button>
          <button class="btn btn-danger" data-dismiss="modal" onclick="deleteSelectedAccounts()">Delete</button>
        </div>
      </div>
    </div>
  </div>
</section>
</body>
</html>
